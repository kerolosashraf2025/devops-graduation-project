trigger:
- main

# ===============================
# Variable Groups + Local Vars
# ===============================
variables:
- group: devops-global-vars
- name: IMAGE_TAG
  value: $(Build.BuildId)

# ===============================
# Stages
# ===============================
stages:
- stage: Build
  displayName: Build & Push Docker Images to Nexus
  jobs:
  - job: BuildImages
    displayName: Build Vote / Result / Worker
    pool:
      vmImage: ubuntu-latest

    steps:
    # -----------------------------
    # Install & Verify Docker
    # -----------------------------
    - task: DockerInstaller@0
      displayName: Install Docker

    - script: |
        docker version
      displayName: Verify Docker

    # -----------------------------
    # Login to Nexus Docker Registry
    # -----------------------------
    - script: |
        echo "$(NEXUS_PASSWORD)" | docker login $(DOCKER_REGISTRY) \
          -u "$(NEXUS_USERNAME)" --password-stdin
      displayName: Docker Login to Nexus

    # -----------------------------
    # Build & Push Vote Image
    # -----------------------------
    - script: |
        docker build -t $(DOCKER_REGISTRY)/$(NEXUS_DOCKER_REPO)/$(VOTE_IMAGE):$(IMAGE_TAG) app/voting-app/vote
        docker push $(DOCKER_REGISTRY)/$(NEXUS_DOCKER_REPO)/$(VOTE_IMAGE):$(IMAGE_TAG)
      displayName: Build & Push Vote Image

    # -----------------------------
    # Build & Push Result Image
    # -----------------------------
    - script: |
        docker build -t $(DOCKER_REGISTRY)/$(NEXUS_DOCKER_REPO)/$(RESULT_IMAGE):$(IMAGE_TAG) app/voting-app/result
        docker push $(DOCKER_REGISTRY)/$(NEXUS_DOCKER_REPO)/$(RESULT_IMAGE):$(IMAGE_TAG)
      displayName: Build & Push Result Image

    # -----------------------------
    # Build & Push Worker Image
    # -----------------------------
    - script: |
        docker build -t $(DOCKER_REGISTRY)/$(NEXUS_DOCKER_REPO)/$(WORKER_IMAGE):$(IMAGE_TAG) app/voting-app/worker
        docker push $(DOCKER_REGISTRY)/$(NEXUS_DOCKER_REPO)/$(WORKER_IMAGE):$(IMAGE_TAG)
      displayName: Build & Push Worker Image
